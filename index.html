<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPI Master Calculator v4 (Complete)</title>
    <style>
        :root {
            --primary: #2563eb;
            --accent: #10b981;
            --orange: #f97316;
            --purple: #8b5cf6;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 85vh;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.2rem; }
        
        /* スクロール可能なタブ */
        .tabs {
            display: flex;
            background: #e2e8f0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            border-bottom: 1px solid #cbd5e1;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab-btn {
            flex: 0 0 auto;
            padding: 12px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.5); }
        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: white;
        }

        /* コンテンツ */
        .content { padding: 20px; display: none; animation: fadeIn 0.2s ease; flex-grow: 1; }
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* スタイル部品 */
        .section-title { font-size: 1rem; font-weight: bold; color: var(--primary); margin: 20px 0 10px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .section-title:first-child { margin-top: 0; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; color: #475569; }
        .input-row { display: flex; gap: 10px; }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1.1rem;
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        /* ボタン色分け */
        .btn-calc {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }
        .btn-calc:active { transform: scale(0.98); }
        .btn-calc.green { background: var(--accent); }
        .btn-calc.orange { background: var(--orange); }
        .btn-calc.purple { background: var(--purple); }
        .btn-reset { background: #64748b; margin-top: 5px; }

        /* 結果エリア */
        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
        }
        .result-label { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; }
        .result-value { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .error { color: #ef4444; font-size: 1rem; }
        
        /* マトリックス */
        .matrix-container { overflow-x: auto; padding-bottom: 10px; }
        .logic-table { margin: 0 auto; border-collapse: collapse; }
        .logic-table th, .logic-table td { border: 1px solid #cbd5e1; width: 40px; height: 40px; text-align: center; vertical-align: middle; padding: 0; }
        .logic-table th { background: #e2e8f0; font-size: 0.8rem; }
        .logic-table input { border: none; background: transparent; text-align: center; font-size: 0.8rem; padding: 0; height: 100%; }
        .logic-cell { font-size: 1.4rem; cursor: pointer; user-select: none; font-weight: bold; }
        .status-o { color: var(--accent); background-color: #ecfdf5; }
        .status-x { color: #ef4444; background-color: #fef2f2; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>SPI Solver v4 (Complete)</h1>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-conc')">濃度算</button>
        <button class="tab-btn" onclick="switchTab('tab-age')">年齢・進数</button>
        <button class="tab-btn" onclick="switchTab('tab-work')">仕事算</button>
        <button class="tab-btn" onclick="switchTab('tab-ratio')">割合・表</button>
        <button class="tab-btn" onclick="switchTab('tab-payment')">割引・分割</button>
        <button class="tab-btn" onclick="switchTab('tab-comb')">順列・確率</button>
        <button class="tab-btn" onclick="switchTab('tab-profit')">損益算</button>
        <button class="tab-btn" onclick="switchTab('tab-speed')">速度算</button>
        <button class="tab-btn" onclick="switchTab('tab-sets')">集合</button>
        <button class="tab-btn" onclick="switchTab('tab-logic')">推論</button>
    </div>

    <!-- NEW: 濃度算 -->
    <div id="tab-conc" class="content active">
        <div class="section-title">食塩水の濃度</div>
        <p style="font-size:0.8rem; color:#64748b;">求めたい項目を1つ空欄にしてください</p>
        <div class="form-group">
            <label>食塩の量 (g)</label>
            <input type="number" id="salt-amount">
        </div>
        <div class="form-group">
            <label>食塩水(全体)の量 (g)</label>
            <input type="number" id="water-amount">
        </div>
        <div class="form-group">
            <label>濃度 (%)</label>
            <input type="number" id="conc-rate">
        </div>
        <button class="btn-calc purple" onclick="calcConcentration()">空欄を計算</button>
        <div class="result-box">
            <div class="result-label">計算結果</div>
            <div id="res-conc" class="result-value">-</div>
        </div>
    </div>

    <!-- NEW: 年齢・進数 -->
    <div id="tab-age" class="content">
        <!-- 年齢算 -->
        <div class="section-title">年齢算</div>
        <div class="input-row">
            <div class="form-group" style="flex:1">
                <label>親の年齢</label>
                <input type="number" id="age-parent" placeholder="例: 40">
            </div>
            <div class="form-group" style="flex:1">
                <label>子の年齢</label>
                <input type="number" id="age-child" placeholder="例: 10">
            </div>
        </div>
        <div class="form-group">
            <label>親が子の何倍になる時？</label>
            <input type="number" id="age-times" placeholder="例: 3">
        </div>
        <button class="btn-calc purple" onclick="calcAge()">何年後か計算</button>
        <div class="result-box" style="margin-top:10px;">
            <div id="res-age" class="result-value">-</div>
        </div>

        <!-- 進数変換 (復活) -->
        <div class="section-title" style="margin-top:30px;">n進数 → 10進数</div>
        <div class="input-row">
            <div class="form-group" style="flex:2">
                <label>数値</label>
                <input type="text" id="base-val" placeholder="1010">
            </div>
            <div class="form-group" style="flex:1">
                <label>何進数?</label>
                <input type="number" id="base-from" value="2">
            </div>
        </div>
        <button class="btn-calc purple" onclick="calcBase()">10進数に変換</button>
        <div class="result-box" style="margin-top:10px;">
            <div id="res-base" class="result-value">-</div>
        </div>
    </div>

    <!-- 仕事算 -->
    <div id="tab-work" class="content">
        <div class="section-title">協力して行う仕事</div>
        <div class="form-group"><label>人Aの時間</label><input type="number" id="work-a"></div>
        <div class="form-group"><label>人Bの時間</label><input type="number" id="work-b"></div>
        <div class="form-group"><label>人Cの時間 (任意)</label><input type="number" id="work-c"></div>
        <button class="btn-calc" onclick="calcWork()">協力時間を計算</button>
        <div class="result-box"><div id="res-work" class="result-value">-</div></div>
    </div>

    <!-- 割合・表計算 -->
    <div id="tab-ratio" class="content">
        <div class="section-title">変化率 (前年比)</div>
        <div class="input-row">
            <div class="form-group" style="flex:1"><label>基準値(前年)</label><input type="number" id="ratio-old"></div>
            <div class="form-group" style="flex:1"><label>比較値(今年)</label><input type="number" id="ratio-new"></div>
        </div>
        <button class="btn-calc green" onclick="calcGrowth()">変化率を計算</button>
        <div class="result-box" style="margin-top:10px;"><div id="res-growth" class="result-value">-</div></div>

        <div class="section-title" style="margin-top:20px;">構成比 (割合)</div>
        <div class="input-row">
            <div class="form-group" style="flex:1"><label>部分</label><input type="number" id="ratio-part"></div>
            <div class="form-group" style="flex:1"><label>全体</label><input type="number" id="ratio-whole"></div>
        </div>
        <button class="btn-calc green" onclick="calcRatio()">割合を計算</button>
        <div class="result-box" style="margin-top:10px;"><div id="res-ratio" class="result-value">-</div></div>
    </div>

    <!-- 割引・分割 -->
    <div id="tab-payment" class="content">
        <div class="section-title">割引</div>
        <div class="input-row">
            <div class="form-group" style="flex:2"><label>定価</label><input type="number" id="disc-price"></div>
            <div class="form-group" style="flex:1"><label>割引率(%)</label><input type="number" id="disc-rate"></div>
        </div>
        <button class="btn-calc orange" onclick="calcDiscount()">計算</button>
        <div class="result-box" style="margin-top:10px;"><div id="res-disc" class="result-value">-</div></div>

        <div class="section-title" style="margin-top:20px;">分割払い</div>
        <div class="form-group"><label>総額</label><input type="number" id="pay-total"></div>
        <div class="input-row">
            <div class="form-group" style="flex:1"><label>回数</label><input type="number" id="pay-count"></div>
            <div class="form-group" style="flex:1"><label>ボーナス回数</label><input type="number" id="pay-bonus-count" value="0"></div>
        </div>
        <div class="form-group"><label>ボーナス加算額</label><input type="number" id="pay-bonus-amount" value="0"></div>
        <button class="btn-calc orange" onclick="calcPayment()">月々の支払額</button>
        <div class="result-box" style="margin-top:10px;"><div id="res-pay" class="result-value">-</div></div>
    </div>

    <!-- 順列・確率 -->
    <div id="tab-comb" class="content">
        <div class="input-row">
            <div class="form-group" style="flex:1"><label>n (全体)</label><input type="number" id="comb-n"></div>
            <div class="form-group" style="flex:1"><label>r (選ぶ数)</label><input type="number" id="comb-r"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-calc" onclick="calcPerm()">nPr</button>
            <button class="btn-calc" onclick="calcComb()">nCr</button>
        </div>
        <div class="result-box"><div id="res-comb" class="result-value">-</div></div>
        
        <div class="section-title" style="margin-top:20px;">確率 (A÷B)</div>
        <div class="input-row">
            <input type="number" id="prob-a" placeholder="対象">
            <input type="number" id="prob-b" placeholder="全体">
        </div>
        <button class="btn-calc green" onclick="calcProb()">確率(%)</button>
        <div class="result-box" style="margin-top:10px;"><div id="res-prob" class="result-value">-</div></div>
    </div>

    <!-- 損益算 -->
    <div id="tab-profit" class="content">
        <div class="form-group"><label>原価</label><input type="number" id="money-cost"></div>
        <div class="form-group"><label>利益率(0.3 or 30)</label><input type="number" id="money-rate"></div>
        <div class="form-group"><label>定価</label><input type="number" id="money-price"></div>
        <button class="btn-calc" onclick="calcMoney()">計算</button>
        <div class="result-box"><div id="res-money" class="result-value">-</div></div>
    </div>

    <!-- 速度算 -->
    <div id="tab-speed" class="content">
        <div class="form-group"><label>速さ</label><input type="number" id="spd-speed"></div>
        <div class="form-group"><label>時間</label><input type="number" id="spd-time"></div>
        <div class="form-group"><label>距離</label><input type="number" id="spd-dist"></div>
        <button class="btn-calc" onclick="calcSpeed()">計算</button>
        <div class="result-box"><div id="res-speed" class="result-value">-</div></div>
    </div>

    <!-- 集合 -->
    <div id="tab-sets" class="content">
        <div class="form-group"><label>全体</label><input type="number" id="set-u"></div>
        <div class="input-row">
            <div class="form-group" style="flex:1"><label>A</label><input type="number" id="set-a"></div>
            <div class="form-group" style="flex:1"><label>B</label><input type="number" id="set-b"></div>
        </div>
        <div class="input-row">
            <div class="form-group" style="flex:1"><label>両方</label><input type="number" id="set-both"></div>
            <div class="form-group" style="flex:1"><label>なし</label><input type="number" id="set-neither"></div>
        </div>
        <button class="btn-calc" onclick="calcSets()">計算</button>
        <div class="result-box" id="set-results" style="text-align:left; font-size:0.9rem;"><div style="text-align:center;">結果</div></div>
    </div>

    <!-- 推論 -->
    <div id="tab-logic" class="content">
        <div class="matrix-container"><table class="logic-table" id="logicMatrix"></table></div>
        <button class="btn-calc btn-reset" onclick="createMatrix()">リセット</button>
        <div style="margin-top:10px; display:flex; gap:10px;">
            <input type="number" id="matrix-rows" value="4" style="width:50px;"><span style="align-self:center;">x</span>
            <input type="number" id="matrix-cols" value="4" style="width:50px;">
            <button onclick="createMatrix()" style="padding:5px 10px;">変更</button>
        </div>
    </div>

</div>

<script>
    function switchTab(tabId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => { if(btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active'); });
    }

    // --- 濃度算 ---
    function calcConcentration() {
        const s = parseFloat(document.getElementById('salt-amount').value);
        const w = parseFloat(document.getElementById('water-amount').value);
        let r = parseFloat(document.getElementById('conc-rate').value);
        const res = document.getElementById('res-conc');

        // %入力補正
        if(!isNaN(r) && r > 1) r = r / 100;

        if(!isNaN(s) && !isNaN(w) && isNaN(r)) {
            // 濃度 = 食塩 / 食塩水
            res.innerText = ((s / w) * 100).toFixed(1) + " %";
        } else if(isNaN(s) && !isNaN(w) && !isNaN(r)) {
            // 食塩 = 食塩水 * 濃度
            res.innerText = (w * r).toFixed(1) + " g";
        } else if(!isNaN(s) && isNaN(w) && !isNaN(r)) {
            // 食塩水 = 食塩 / 濃度
            res.innerText = (s / r).toFixed(1) + " g";
        } else {
            res.innerHTML = '<span class="error">2箇所入力してください</span>';
        }
    }

    // --- 年齢算 ---
    function calcAge() {
        const p = parseFloat(document.getElementById('age-parent').value);
        const c = parseFloat(document.getElementById('age-child').value);
        const t = parseFloat(document.getElementById('age-times').value);
        const res = document.getElementById('res-age');
        
        if(isNaN(p) || isNaN(c) || isNaN(t)) { res.innerHTML = '<span class="error">入力エラー</span>'; return; }
        
        // 方程式: (p + x) = t * (c + x)
        // p + x = tc + tx
        // p - tc = tx - x
        // p - tc = x(t - 1)
        // x = (p - tc) / (t - 1)
        
        if(t === 1) { res.innerText = "倍率が1の場合は計算できません"; return; }
        
        const x = (p - (t * c)) / (t - 1);
        
        if(x >= 0) {
            res.innerText = x + " 年後";
        } else {
            res.innerText = Math.abs(x) + " 年前";
        }
    }
    
    // --- 進数 ---
    function calcBase() {
        const v = document.getElementById('base-val').value;
        const b = parseInt(document.getElementById('base-from').value);
        try {
            const r = parseInt(v, b);
            if(isNaN(r)) throw "err";
            document.getElementById('res-base').innerText = r;
        } catch(e) { document.getElementById('res-base').innerText = "エラー"; }
    }

    // --- 他の計算関数 (v3から継承・短縮) ---
    function calcWork(){
        const a=parseFloat(document.getElementById('work-a').value), b=parseFloat(document.getElementById('work-b').value), c=parseFloat(document.getElementById('work-c').value);
        if(isNaN(a)||isNaN(b)){document.getElementById('res-work').innerHTML='<span class="error">入力エラー</span>';return;}
        let r=(1/a)+(1/b); if(!isNaN(c)) r+=(1/c);
        document.getElementById('res-work').innerText = (1/r).toFixed(2) + " 日/時間";
    }
    function calcGrowth(){
        const o=parseFloat(document.getElementById('ratio-old').value), n=parseFloat(document.getElementById('ratio-new').value);
        if(isNaN(o)||isNaN(n)){document.getElementById('res-growth').innerText="エラー";return;}
        const p=((n-o)/o)*100; document.getElementById('res-growth').innerText = (p>=0?"+":"") + p.toFixed(1) + " %";
    }
    function calcRatio(){
        const p=parseFloat(document.getElementById('ratio-part').value), w=parseFloat(document.getElementById('ratio-whole').value);
        if(isNaN(p)||isNaN(w)){document.getElementById('res-ratio').innerText="エラー";return;}
        document.getElementById('res-ratio').innerText = ((p/w)*100).toFixed(1) + " %";
    }
    function calcDiscount(){
        const p=parseFloat(document.getElementById('disc-price').value), r=parseFloat(document.getElementById('disc-rate').value);
        if(isNaN(p)||isNaN(r)) return;
        const rate = r>=1 ? r/100 : r;
        document.getElementById('res-disc').innerText = Math.round(p*(1-rate)).toLocaleString() + " 円";
    }
    function calcPayment(){
        const t=parseFloat(document.getElementById('pay-total').value), c=parseFloat(document.getElementById('pay-count').value);
        let bc=parseFloat(document.getElementById('pay-bonus-count').value)||0, ba=parseFloat(document.getElementById('pay-bonus-amount').value)||0;
        if(isNaN(t)||isNaN(c)) return;
        const rem = t - (bc*ba);
        if(rem<0) {document.getElementById('res-pay').innerText = "エラー"; return;}
        document.getElementById('res-pay').innerText = Math.ceil(rem/c).toLocaleString() + " 円";
    }
    function factorial(n){if(n<0)return -1;if(n==0)return 1;let r=1;for(let i=2;i<=n;i++)r*=i;return r;}
    function calcPerm(){const n=document.getElementById('comb-n').value,r=document.getElementById('comb-r').value; document.getElementById('res-comb').innerText=(factorial(n)/factorial(n-r)).toLocaleString();}
    function calcComb(){const n=document.getElementById('comb-n').value,r=document.getElementById('comb-r').value; document.getElementById('res-comb').innerText=(factorial(n)/(factorial(r)*factorial(n-r))).toLocaleString();}
    function calcProb(){const a=document.getElementById('prob-a').value,b=document.getElementById('prob-b').value; document.getElementById('res-prob').innerText=((a/b)*100).toFixed(2)+"%";}
    function calcMoney(){
        let c=parseFloat(document.getElementById('money-cost').value), r=parseFloat(document.getElementById('money-rate').value), p=parseFloat(document.getElementById('money-price').value);
        const res=document.getElementById('res-money'); if(r>=1)r/=100;
        if(!isNaN(c)&&!isNaN(r)) res.innerText=Math.round(c*(1+r)).toLocaleString()+"円";
        else if(!isNaN(p)&&!isNaN(r)) res.innerText=Math.round(p/(1+r)).toLocaleString()+"円";
        else if(!isNaN(c)&&!isNaN(p)) res.innerText=(((p-c)/c)*100).toFixed(1)+"%";
    }
    function calcSpeed(){
        let s=parseFloat(document.getElementById('spd-speed').value), t=parseFloat(document.getElementById('spd-time').value), d=parseFloat(document.getElementById('spd-dist').value);
        const res=document.getElementById('res-speed');
        if(!isNaN(s)&&!isNaN(t)) res.innerText=(s*t).toLocaleString();
        else if(!isNaN(d)&&!isNaN(s)) res.innerText=(d/s).toFixed(2);
        else if(!isNaN(d)&&!isNaN(t)) res.innerText=(d/t).toFixed(2);
    }
    function calcSets(){
        const u=parseInt(document.getElementById('set-u').value), a=parseInt(document.getElementById('set-a').value), b=parseInt(document.getElementById('set-b').value);
        const both=parseInt(document.getElementById('set-both').value), n=parseInt(document.getElementById('set-neither').value);
        let h="";
        if(!isNaN(a)&&!isNaN(b)&&!isNaN(both)) { h+=`A or B: ${a+b-both}<br>`; if(!isNaN(u)) h+=`Neither: ${u-(a+b-both)}<br>`; }
        if(!isNaN(u)&&!isNaN(a)&&!isNaN(b)&&!isNaN(n)) { const bo=a+b-(u-n); h+=`Both: ${bo}<br>`; document.getElementById('set-both').value=bo;}
        document.getElementById('set-results').innerHTML = h||"計算不可";
    }
    function createMatrix(){
        const r=document.getElementById('matrix-rows').value, c=document.getElementById('matrix-cols').value, t=document.getElementById('logicMatrix');
        t.innerHTML=""; let tr=document.createElement('tr'); tr.innerHTML='<th></th>';
        for(let i=0;i<c;i++)tr.innerHTML+=`<th><input placeholder="${String.fromCharCode(65+i)}"></th>`; t.appendChild(tr);
        for(let i=0;i<r;i++){ tr=document.createElement('tr'); tr.innerHTML=`<th><input placeholder="${i+1}"></th>`;
            for(let j=0;j<c;j++){let td=document.createElement('td'); td.className='logic-cell'; td.onclick=function(){
                if(this.innerText==''){this.innerText='○';this.className='logic-cell status-o';}
                else if(this.innerText=='○'){this.innerText='×';this.className='logic-cell status-x';}
                else{this.innerText='';this.className='logic-cell';}
            }; tr.appendChild(td);} t.appendChild(tr);
        }
    }
    window.onload=createMatrix;
</script>

</body>
</html>
